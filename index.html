<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <style>
    [v-cloak] { display: none; }
  </style>
</head>
<body>
  <div id="app">
    <v-app>

      <v-navigation-drawer app v-model="drawer" style="z-index:201 !important;">
        <v-list dense  v-cloak>
          <v-list-item v-for="(menuItem, i) in nav" :key="i" @click="clicked(menuItem.file)">
            <v-list-item-action><v-icon>{{menuItem.icon}}</v-icon></v-list-item-action>
            <v-list-item-content><v-list-item-title>{{menuItem.title}}</v-list-item-title></v-list-item-content>
          </v-list-item>
        </v-list>
      </v-navigation-drawer>
  
      <v-card tile class="overflow-hidden">
        <v-app-bar
          ref="header"
          id="appbar"
          app
          prominent
          :height="bannerHeight"
          elevate-on-scroll
          fade-img-on-scroll
          dark
          shrink-on-scroll
          :src="banner"
          scroll-target="#scrollableContent"
          :scroll-threshold="scrollThreshold"
        >
  
          <v-app-bar-nav-icon @click.stop="drawer = !drawer"></v-app-bar-nav-icon>
          <v-toolbar-title v-cloak>{{title}}</v-toolbar-title>
          <v-spacer></v-spacer>
        </v-app-bar>
  
        <v-sheet id="scrollableContent" class="overflow-y-auto" :style="`height:${height}px;`">
          <v-container id="contentContainer" ref="contentContainer" :style="`margin-top: ${essayTopMargin}px; height:100%;`">
            <v-layout>
              <v-flex><div ref="content" v-html="html"></div></v-flex>
            </v-layout>
          </v-container>
        </v-sheet>
  
        <v-footer ref="footer" :fixed="fixed" app>
          <v-flex ref="footer" class="text-xs-left"></v-flex>
        </v-footer>

      </v-card>
    </v-app>
  </div>

  <script src="https://github.com/JSTOR-Labs/visual-essays/blob/master/lib/visual-essays-0.4.5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        drawer: false,
        fixed: true,
        nav: [
          { file: 'index', title: 'Home', icon: 'mdi-home' },
          { file: 'about', title: 'About', icon: 'mdi-information' },
          { file: 'help', title: 'Help', icon: 'mdi-help-circle' },
          { file: 'contact', title: 'Contact', icon: 'mdi-contact-mail' },
          { file: 'resources', title: 'Resources', icon: 'mdi-library' }
        ],
        title: 'Visual Essay',
        banner: 'https://picsum.photos/1200/225',
        bannerHeight: 200,
        scrollThreshold: 150,
        height: 0,
        essayTopMargin: 200,
        html: undefined,
        service: 'https://visual-essay-atjcn6za6q-uc.a.run.app',
        acct: undefined,
        repo: undefined,
        rtime: undefined,
        timeout: false,
        delta: 200
      }),
      mounted() {
        console.log(window.location)
        const path = (window.location.hash ? window.location.hash.slice(1) : window.location.pathname).split('/').slice(window.location.hostname.indexOf('github.io') > 0 ? 2 : 1)
        console.log('path', path)
        this.acct = window.location.hostname.replace(/\.github\.io/, '')
        this.repo = window.location.pathname.split('/')[1]
        /*
        let file
        if (window.location.hostname === 'localhost') {
          this.service = 'http://localhost:5000'
        }
        if (this.service === 'http://localhost:5000' && path.len > 1) {
          file = path[0] !== '' ? path[0] : undefined
        } else {
          this.acct = path[0] !== '' ? path[0] : undefined
          this.repo = path.length > 1 ? path[1] : undefined
          file = path.length > 2 ? path[2] : undefined
        }
        */
        console.log(`essay: service=${this.service} acct=${this.acct} repo=${this.repo}`)
        this.setAndWatchHeight()
        this.load()
      },
      methods: {
        clicked(page) {
          this.drawer = false
          this.load(page)
        },
        load(file) {
          const url = this.service + (this.acct ? `/${this.acct}` : '') + (this.repo ? `/${this.repo}` : '') + (file ? `/${file}` : '')
          console.log(`load ${url}`)
          fetch(url).then(resp => resp.text())
          .then(html => {
            this.html = html
            this.$nextTick(() => {
              window._essay = document.getElementById('essay').dataset.name
              document.querySelectorAll('script[type="application/ld+json"]').forEach((scr) => {
                eval(scr.text)
              })
              console.log(window.data)
            })
          })
        },
        setAndWatchHeight() {
          this.height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - this.$refs.footer.$el.offsetHeight
          window.addEventListener('resize', () => {
            this.rtime = new Date()
            if (this.timeout === false) {
              this.timeout = true
              setTimeout(this.resizeend, this.delta)
            }
          })
        },
        resizeend() {
          if (new Date() - this.rtime < this.delta) {
            setTimeout(this.resizeend, this.delta)
          } else {
            this.timeout = false
            this.height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - this.$refs.footer.$el.offsetHeight
          }
        }
      },
      watch: {
      }
    })
  </script>
</body>
</html>