<!DOCTYPE html>
<html>
<head>
  <link  href="/static/favicon.ico" rel="icon" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <script src="https://unpkg.com/http-vue-loader"></script>
  <style>
    [v-cloak] { display: none; }

    #essay>p>a {
      font-size: 18px;
      font-weight: 500;
    }

    #essay ul {
      padding-left: 50px;
    }

    .hero-title {
      font-family: 'Georgia', serif;
      max-width: 80vw;
      font-size: 40px;
      position: absolute;
      top: calc(50% - 44px);
      margin-left: 20px;
    }

    .hero-title span {
      padding: 8px;
      background-color: black;
      -webkit-box-decoration-break: clone;
      box-decoration-break: clone;
      margin-bottom: 0 !important;
    }

    .v-application--is-ltr .v-toolbar__content>.v-btn.v-btn--icon:first-child, .v-application--is-ltr .v-toolbar__extension>.v-btn.v-btn--icon:first-child {
      margin-left: -21px;
    }

   .v-toolbar__image .v-image, .v-toolbar__content, #appbar{
      min-height: 104px!important;
    }

    .footer {
      position: absolute;
      bottom: 0;
      padding: 0 24px 8px;
      width: 100%;
      box-shadow: 0px -2px 2px 0px rgba(0,0,0,0.1);
      border-top: 1px solid #d4d4d4;
      background-color: white
    }

    .lingallery, .openseadragon-container, #cards-image-viewer  {
      padding-left: 30px!important
    }
  </style>
</head>
<body>
  <div id="app">
    <v-app>

      <v-navigation-drawer app v-model="drawer" style="z-index:201 !important;">
        <v-list dense v-cloak>
          <v-list-item v-for="(menuItem, i) in nav" :key="i" @click="menuItemClicked(menuItem.file)" v-if="menuItem.enabled">
            <v-list-item-action><v-icon>{{menuItem.icon}}</v-icon></v-list-item-action>
            <v-list-item-content><v-list-item-title>{{menuItem.title}}</v-list-item-title></v-list-item-content>
          </v-list-item>
          <v-divider></v-divider>
          <v-list-item><v-list-item-content style="font-size:0.8em;margin-top:36px;">App version:{{appVersion}}</v-list-item-content></v-list-item>        
          <v-list-item><v-list-item-content style="font-size:0.8em;">Lib version: {{libVersion}}</v-list-item-content></v-list-item>        
        </v-list>
      </v-navigation-drawer>

      <v-card tile class="overflow-hidden">
        <v-app-bar
          app dark prominent
          elevate-on-scroll shrink-on-scroll
          id="appbar"
          elevation="6"
          :src="banner"
          :height="bannerHeight"
          scroll-target="#scrollableContent"
          :scroll-threshold="scrollThreshold"
        >

          <v-app-bar-nav-icon @click.stop="drawer = !drawer"></v-app-bar-nav-icon>

          <template v-if="isEssay">
            <essay-header v-if="customComponents.essayHeader" :essay-config="essayConfig" :progress="progress"></essay-header>
          </template>
          <template v-else>
            <div v-if="siteConfig.tagline" v-cloak class="hero-title" >
              <span v-html="siteConfig.tagline"></span>
            </div>
            <v-toolbar-title v-else v-cloak v-html="title"></v-toolbar-title>
          </template>

        </v-app-bar>

        <v-sheet ref="scrollableContent" id="scrollableContent" class="overflow-y-auto" :style="`height:${height}px;`">
          <v-container id="contentContainer" ref="contentContainer" :style="`!important; margin-top: ${essayTopMargin}px; height:100%;`">
            <v-layout>
              <v-flex><div id="content" ref="content" v-html="html"></div></v-flex>
            </v-layout>
          </v-container>
        </v-sheet>

        <!-- footer -->
        <v-footer v-if="showFooter" v-cloak app color="#fff" elevation="6">
          <site-footer></site-footer>
        </v-footer>

      </v-card>
    </v-app>
  </div>

  <script src="https://JSTOR-Labs.github.io/visual-essays/lib/visual-essays.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

  <script>
    String.prototype.capitalize = function() { return this.charAt(0).toUpperCase() + this.slice(1) }
    String.prototype.titleize = function() {
      var string_array = this.replace(/-/, ' ').split(' ')
      string_array = string_array.map(function(str) { return str.capitalize() })
      return string_array.join(' ')
    }

    let defaults = {
      'jstor-labs.github.io': {acct: 'jstor-labs', repo: 'visual-essays', title: 'Visual Essays'},
      'localhost': {acct: 'jstor-labs', repo: 'visual-essays', title: 'Visual Essays'},
      'visual-essays.app': {acct: 'jstor-labs', repo: 'visual-essays', title: 'Visual Essays'},
      'plant-humanities.app': {acct: 'jstor-labs', repo: 'plant-humanities', title: 'Plant Humanities'},
      'kent-maps.online': {acct: 'kent-map', repo: 'dickens', title: 'Kent Maps'},
      'dickens.kent-maps.online': {acct: 'kent-map', repo: 'dickens', title: 'Kent Maps'}
    }
    console.log(window.location)
    const hostname = window.location.hostname.toLowerCase()
    const service = hostname === 'localhost' ? 'http://localhost:5000' : defaults[hostname] ? `https://${hostname}` : `https://visual-essays.app`
    let acct, repo, file
    const path = (window.location.hash ? window.location.hash.slice(1) : window.location.pathname.slice(1)).split('/').slice(hostname.indexOf('github.io') > 0 ? 1 : 0).filter(elem => elem !== '')
    console.log(path)
    if (path.length < 2) {
      if (hostname.indexOf('.github.io') >= 0) {
        acct = hostname.replace(/\.github\.io/, '')
        repo = pathname.split('/')[1]
      } else {
        acct = defaults[hostname].acct
        repo = defaults[hostname].repo
      }
      file = path.length === 1 && path[0] !== '' ? path[0] : undefined
    } else {
      acct = path[0]
      repo = path[1]
      file = path[2]
    }
    console.log(`hostname=${hostname} service=${service} acct=${acct} repo=${repo} file=${file}`)
    const configUrl = `${service}/config` + (acct ? `/${acct}` : '') + (repo ? `/${repo}` : '')
    fetch(configUrl)
      .then(resp => {return resp.ok ? resp.json() : {}})
      .then(siteConfig => {
      console.log('siteConfig', siteConfig)
      const customComponents = siteConfig ? siteConfig.customComponents || {} : {}

    window.app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      components: {
        'essayHeader': customComponents.essayHeader ? httpVueLoader(customComponents.essayHeader) : undefined,
        'siteFooter': customComponents.siteFooter ? httpVueLoader(customComponents.siteFooter) : undefined
      },
      data: () => ({
        drawer: false,
        nav: [
          { title: 'Home', icon: 'mdi-home', enabled: true },
          { file: 'about', title: 'About', icon: 'mdi-information', enabled: false },
          { file: 'contact', title: 'Contact', icon: 'mdi-contact-mail', enabled: false },
          { file: 'help', title: 'Help', icon: 'mdi-help-circle', enabled: false },
          { file: 'resources', title: 'Resources', icon: 'mdi-library', enabled: false }
        ],
        bannerHeight: 400,
        height: 0,
        html: undefined,
        rtime: undefined,
        timeout: false,
        isLoaded: false,
        delta: 200,
        siteConfig,
        customComponents,
        essayCache: {},
        ec: {test: 'test'},
        appVersion: '0.3.0',
        libVersion: undefined,
        essayConfig: undefined,
        progress: 1
      }),
      computed: {
        banner() { return this.isEssay ? this.essayConfig.banner : this.siteConfig.banner ? `${this.siteConfig.banner}` : undefined },
        title() { return this.isEssay ? this.essayConfig.title : this.siteConfig.title || repo ? repo.titleize() : '' },
        numLocations() { return this.isEssay ? this.essayConfig['num-locations'] || 0 : 0 },
        numImages() { return this.isEssay ? this.essayConfig['num-images'] || 0 : 0 },
        numSpecimens() { return this.isEssay ? this.essayConfig['num-specimens'] || 0 : 0 },
        numPrimarySources() { return this.isEssay ? this.essayConfig['num-primary-sources'] || 0 : 0 },
        author() { return this.isEssay ? this.essayConfig['author'] || '' : '' },
        essayTopMargin() { return this.bannerHeight },
        //essayTopMargin() { return this.bannerHeight + (this.essayConfig ? 96 : 0) },
        scrollThreshold() { return this.isEssay ? 400 : 350 },
        isEssay() { return this.essayConfig !== undefined },
        showFooter() { return !this.isEssay && this.siteConfig.showFooter && this.customComponents.siteFooter}
      },
      mounted() {
        document.getElementById('appbar').addEventListener('wheel', this.throttle(this.scrollContent, 20))
        // this.$refs.scrollableContent.$el.scrollTo(0, 600)
        window.onpopstate = (e) => { this.loadEssay(e.state.file, true) }      
        this.setAndWatchHeight()
        this.loadEssay(file)
        // Find and preload navigation pages
        this.nav.filter(navItem => !navItem.enabled)
        .forEach(navItem => {
          this.cachingFetch(navItem.file)
          .then(html => {
            if (html) {
              this.nav.map(item => item.enabled = item.enabled || item.file == navItem.file)
            }
          })
        })
      },
      methods: {
        throttle(callback, interval) {
          let enableCall = true
          return function(...args) {
            if (!enableCall) return
            enableCall = false
            callback.apply(this, args)
            setTimeout(() => enableCall = true, interval)
          }
        },
        scrollContent(e) {
          const wheelDelta = e.wheelDelta
          // console.log(`scrollDirection ${wheelDelta > 0 ? 'down' : 'up'} ${wheelDelta}`)
          this.$refs.scrollableContent.$el.scrollTo(0, this.$refs.scrollableContent.$el.scrollTop - wheelDelta)
        },
        menuItemClicked(file) {
          this.drawer = false
          this.loadEssay(file)
        },
        cachingFetch(file) {
          const url = file === 'help'
            ? 'https://visual-essays.app/essay/help'
            : `${service}/essay` + (acct ? `/${acct}` : '') + (repo ? `/${repo}` : '') + (file ? `/${file}` : '')
          console.log(`loadEssay: service=${service} acct=${acct} repo=${repo} file=${file} cached=${this.essayCache[url] !== undefined}`)
          if (!this.essayCache[url]) {
            this.essayCache[url] = fetch(url).then((resp) => resp.ok ? resp.text() : null)
          }
          return this.essayCache[url]
        },
        loadEssay(file, replace) {
          this.cachingFetch(file)
          .then(html => {
            let browserPath = `${acct === defaults[hostname].acct && repo === defaults[hostname].repo ? '' : '/'+acct}${acct === defaults[hostname].acct && repo === defaults[hostname].repo ? '' : '/'+repo}${file ? '/'+file : ''}` || '/'
            if (replace) {
              history.replaceState({file: file}, '', browserPath)
            } else {
              history.pushState({file: file}, '', browserPath)
            }
            this.html = html
            this.$nextTick(() => window._essay = document.getElementById('essay').dataset.name)
          })
        },
        setAndWatchHeight() {
          this.height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - (this.showFooter ? 75 : 0)
          window.addEventListener('resize', () => {
            this.rtime = new Date()
            if (this.timeout === false) {
              this.timeout = true
              setTimeout(this.resizeend, this.delta)
            }
          })
        },
        resizeend() {
          if (new Date() - this.rtime < this.delta) {
            setTimeout(this.resizeend, this.delta)
          } else {
            this.timeout = false
            this.height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - (this.showFooter ? 75 : 0)
          }
        }
      },
      watch: {
        isLoaded() {
          if (this.isLoaded) {
            this.isLoaded = false
            this.$nextTick(() => {
              const scrollableContent = document.getElementById('scrollableContent')
              if (scrollableContent) {
                scrollableContent.scrollTo(0, 0)
              }
              // convert embedded essay links
              document.getElementById('essay').querySelectorAll('a').forEach(link => {
                if (link.href.indexOf(service) === 0) {
                  const parsedUrl = parseUrl(link.href)
                  const target = parsedUrl.hash === '' 
                    ? parsedUrl.pathname.slice(parsedUrl.pathname.lastIndexOf('/')+1)
                    : parsedUrl.hash
                  console.log(`target=${target}`)
                  link.addEventListener('click', () => {
                    if (target[0] === '#') {
                      document.querySelector(target).scrollIntoView({block:'center'})
                    } else {
                      this.loadEssay(target)
                    }
                  })
                  link.removeAttribute('href')
                } else {
                  link.innerHTML += '<sup><i class="fal fa-external-link-alt" style="margin-left:4px;font-size:0.8em;color:blue;"></i></sup>'
                  link.setAttribute('target', '_blank')
                }
              })
            })
          }
        }
      }
    })
  })
    function parseUrl (href) {
      const match = href.match(/^(https?)\:\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/)
      return match && {
        protocol: match[1],
        host: match[2],
        hostname: match[3],
        origin: `${match[1]}://${match[2]}`,
        port: match[4],
        pathname: match[5],
        search: match[6],
        hash: match[7]
      }
    }
  </script>
</body>
</html>